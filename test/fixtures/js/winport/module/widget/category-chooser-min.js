(function(d,c){var b=new c.Class({init:function(e){this.config=e;this.node=d(this._template);this.node.appendTo(e.appendTo);this._initCatsList();this._handleCatsEvent()},_initCatsList:function(){var f=this,h=this.config.dataProvider,e=this.config.selectedCategory,g=d("div.w-content",this.node);h.loadCategories(function(i){var j=[];d.each(i,function(l,k){j.push(d.util.substitute(f._itemTemplate,f._filterCat(k)))});g.html("<ul>"+j.join("")+"</ul>");d("li",g).each(function(m){var l=i[m],k=d(this);k.data("cat",l);if(e===l.id){k.addClass("selected");f._doSelect(l,true)}})},function(){g.html('<div class="message">网络繁忙，请稍候重试！</div>')})},_filterCat:function(e){var f=d.extend({},e);f.formatedName=e.name.length>6?e.name.substr(0,6)+"..":e.name;return f},_handleCatsEvent:function(){var f=this,e=this.config.select;this.node.delegate("a.name","click",function(i){i.preventDefault();var h=d(this).closest("li"),g=h.data("cat");h.siblings().removeClass("selected");h.addClass("selected");f._showError(false);f._doSelect(g)})},_doSelect:function(f,h){var e=this.config.select,g=this._selectedCat;this._selectedCat=f;e&&e(f,g,h)},_showError:function(e){var f=d("div.w-header div.message",this.node);if(e===false){f.removeClass("error")}else{f.addClass("error");setTimeout(function(){f.removeClass("error")},3000)}},validate:function(){if(!this._selectedCat){this._showError();return false}return true},getSelectedCategory:function(){return this._selectedCat},_template:'<div class="widget-category-chooser">	<div class="w-header">		<h3>我的信息</h3>		<div class="message">请先选择一个类目</div>	</div>	<div class="w-content"><div class="loading">正在载入...</div></div></div>',_itemTemplate:'<li><a href="#" title="{name}" class="name">{formatedName}</a> <span class="count">{offerCount}</span></li>'});var a=new c.Class(c.widget.Dialog,{init:function(f){var e=this,g=d.extend({header:"选择产品",className:"category-offer-chooser-dialog",draggable:true},f,{contentSuccess:function(){d.use("wp-offer-chooser",d.proxy(e,"_contentSuccess"))},buttons:[{"class":"d-confirm",value:"确定"},{"class":"d-cancel",value:"取消"}],confirm:d.proxy(this,"_confirm")});this.parent.init.call(this,g);this._confirmHandler=f.confirm;this._cancelHandler=f.cancel},_contentSuccess:function(){this.setContent("");this._showCategoryChooser()},_showCategoryChooser:function(){var e=this,f=null,g=(this.config.selectedOffers||[]).length===0;if(!this._categoryChooser){f=d.extendIf({appendTo:this.getContainer(),dataProvider:this.config.dataProvider.cdp,select:function(h,i,j){if(j&&g){return}e._showOfferChooser(h)}},this.config);this._categoryChooser=new b(f)}this.node.removeClass("offer-chooser-active").addClass("category-chooser-active")},_showOfferChooser:function(e){var f=null;if(this._offerChooser){if(this._selectedCat&&this._selectedCat.id!==e.id){this._offerChooser.node.remove();f=this._getOfferChooserConfig(e);f.selectedOffers=[];this._offerChooser=new c.widget.OfferChooser(f)}}else{f=this._getOfferChooserConfig(e);this._offerChooser=new c.widget.OfferChooser(f)}this._selectedCat=e;this.node.removeClass("category-chooser-active").addClass("offer-chooser-active")},_getOfferChooserConfig:function(e){var f=this;return d.extendIf({appendTo:this.getContainer(),dataProvider:this.config.dataProvider.odp,selectedCategory:e,comeback:{text:"返回类目选择",action:function(){f._showCategoryChooser()}}},this.config)},getData:function(){if(!this._offerChooser){return}var f=this._selectedCat,e=this._offerChooser.getSelectedOffers();return{category:f,offers:e}},_confirm:function(){if(this.node.hasClass("offer-chooser-active")){this._confirmHandler?this._confirmHandler(this):this.close();return}if(this._selectedCat||this._categoryChooser.validate()){this._showOfferChooser(this._selectedCat||this._categoryChooser.getSelectedCategory())}}});c.widget.CategoryChooser=b;c.widget.CategoryOfferChooserDialog=a;d.add("wp-category-chooser");d.add("wp-category-offer-chooser")})(jQuery,Platform.winport);