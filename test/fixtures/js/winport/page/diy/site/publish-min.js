(function(f,d){var b=d.diy,o=b.Diy,m=d.Util,e=b.Msg,k=d.widget.Dialog,n,l,h,j,g,i,a;var c={init:function(){var p=this;n=f("#doc").data("doc-config");l=f("#content").data("content-config");h=l.isHomepage;f("#header div.setting-bar a.publish").click(function(q){q.preventDefault();p._openPublishDialog();return false});f("#header div.setting-bar a.backup-tool-item").click(function(q){q.preventDefault();d.diy.Template.backup({success:function(){Platform.winport.SettingContext.loadPage(2,{showBackup:true})},error:function(r){e.error("\u5907\u4efd\u6a21\u677f\u5931\u8d25\uff0c\u8bf7\u5237\u65b0\u540e\u91cd\u8bd5\u3002")}});return false})},_openPublishDialog:function(){g=g||this._getPublishAreaContent("textarea.site-publish");var p=this;this.publishDialog=k.open({header:"\u53d1\u5e03",className:"publish-dialog",hasClose:false,buttons:[{"class":"d-confirm",value:"\u786e\u8ba4\u53d1\u5e03"},{"class":"d-cancel",value:"\u53d6\u6d88"}],draggable:true,content:g,contentSuccess:function(q){q=q.node;f("#sync-page").change(function(){if(f(this)[0].checked){f("a.sync-setting",q).css("display","inline-block");var r=f("div.sync-setting-panel",q);if(r.length>0){f(".input-checkbox",r).each(function(s,t){t.checked=true})}}else{f("a.sync-setting",q).css("display","none");f("div.sync-setting-panel",q).css("display","none")}});f("a.sync-setting",q).click(function(t){t.preventDefault();var s=f("div.sync-setting-wrap",q),r=f("div.sync-setting-panel",q);if(r.length===0&&!s.data("hasPageList")){p._getSyncPageList(s)}f("div.sync-setting-panel",q).css("display","block")})},confirm:function(q){p._publish(f("form",q.node))}})},_getPublishAreaContent:function(p){var q=f(p),r=q.val();q.remove();return r},_getSyncPageList:function(r){var q=this,p=n.listSyncPageUrl;r.data("hasPageList",true);f.ajax(p,{cache:false,success:function(s){q.syncPageList=f(s);f(s).insertAfter(r)},error:function(){e.warn("\u7f51\u7edc\u7e41\u5fd9\uff0c\u8bf7\u5237\u65b0\u540e\u91cd\u8bd5")}})},_publish:function(s){var r=this,u=n.publishSiteUrl+"?_input_charset=UTF-8",q=[],t=s.serializeArray();r.publishDialog.showLoading("\u6b63\u5728\u53d1\u5e03..");j=f('input[name="is-sync-page-side"]',s).prop("checked");f(t).each(function(x,w){if(w.name==="sync-page"){q.push(parseInt(w.value,10))}});var p=f("div.sync-setting-panel",s);if(j&&p.length>0&&q.length===0){j=false}o.authAjax(u,{type:"POST",data:{_csrf_token:n._csrf_token,pageSid:l.sid,needSyncSide:j,syncPageList:JSON.stringify(q)},dataType:"json",timeout:20000,success:function(v){r.publishDialog.close();if(v.success){r._publishSuccess(v)}else{r._publishFailed()}},error:function(){r.publishDialog.showLoading(false);e.warn("\u7f51\u7edc\u7e41\u5fd9\uff0c\u8bf7\u5237\u65b0\u540e\u91cd\u8bd5")}})},_publishSuccess:function(p){if(!i){i=this._getPublishAreaContent("textarea.site-publish-success")}k.open({header:"\u53d1\u5e03",className:"publish-success-dialog",content:i,draggable:true,contentSuccess:function(t){f("a.open-wp",t.node).click(function(u){t.close();if(!h&&j){window.location.reload()}});f("a.back-diy",t.node).click(function(u){u.preventDefault();t.close();if(!h&&j){window.location.reload()}return false});var r=p.data,s=null,q="";if(r&&(s=r.MAX_WIDGETS_ERR)){if(s.length>0){q+="<li>"+s.join("\u3001")+s.length+"\u4e2a\u9875\u9762\u540c\u6b65\u540e\u8d85\u8fc720\u4e2a\u677f\u5757\uff0c\u540c\u6b65\u5931\u8d25\uff0c\u8bf7\u5220\u9664\u90e8\u5206\u4fa7\u8fb9\u680f\u677f\u5757\u540e\u91cd\u8bd5\uff01</li>"}}if(r&&(s=r.OTHER_ERR)){if(s.length>0){q+="<li>"+s.join("\u3001")+s.length+"\u4e2a\u9875\u9762\u540c\u6b65\u5931\u8d25\uff01</li>"}}if(q!==""){f("<ul>",{"class":"pub-result-msg"}).html(q).insertAfter(f("p.d-msg",t))}}})},_publishFailed:function(){if(!a){a=this._getPublishAreaContent("textarea.site-publish-failed")}var p=this;k.open({header:"\u53d1\u5e03",className:"publish-failed-dialog",content:a,contentSuccess:function(q){f("a.back-diy",q.node).click(function(r){r.preventDefault();q.close();return false})}})}};d.PageContext.register("~SitePublish",c)})(jQuery,Platform.winport);
