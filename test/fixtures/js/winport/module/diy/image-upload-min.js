(function(c,a){var d=a.Util;var b=d.mkclass({init:function(e,f){this.panel=e;this.config=f;var g=(this.preview=c("div.preview",e));this.img=c("img",g);this.remove=c("a.remove",g);this.pathInput=c("input.path",g);this.message=c("div.message",e);this.initPreview();this.handleUpload();this.handleRemove()},initPreview:function(){if(!this.img.length){this.img=c("<img />").prependTo(this.preview)}var f=this.img.attr("src"),e=this.pathInput.val();if(!f&&e){this.img.attr("src",e);f=e}f&&this.preview.show()},handleUpload:function(){var e=this,h=this.config,g=h.imageUploadUrl,f=c("div.upload",this.panel),i=c("div.loading",this.panel);c.use("ui-flash-uploader",function(){f.flash({module:"uploader"});f.bind("fileSelect.flash",function(k,j){c(this).flash("uploadAll",g,{_csrf_token:h._csrf_token,name:"file1",memberId:h.uid,source:"winport_diy",drawFootTxt:false,noScale:h.noScale})});f.bind("uploadStart.flash compressStart.flash",function(j){c.log("ImageUpload: "+j.type);e.showMessage(false);i.show()});f.bind("uploadCompleteData.flash",function(m,n){c.log("ImageUpload: uploadComplete");i.hide();var l=n.data||{};if(typeof l==="string"){l=c.parseJSON(l)}if(l.result==="success"){e.uploadSuccess(l.imgUrls);return}var k=l.errMsg||"",j=typeof k==="string"?k.split(",")[0]:k[0];e.uploadError(j)})})},uploadError:function(e){var f=this.getErrorMessage(e);this.showMessage("error",f)},getErrorMessage:function(e){var f={TYPEERR:"抱歉，图片格式不正确！请上传jpg、jpeg、gif、png、bmp格式的图片",IMGTYPEERR:"抱歉，图片格式不正确！请上传jpg、jpeg、gif、png、bmp格式的图片",IMGSIZEERR:"抱歉，图片大小超出最大限制！请上传1MB以内的图片",IMGREQUIRED:"抱歉，图片大小超出最大限制！请上传1MB以内的图片"};e=(e||"").toUpperCase();return f[e]||"网络繁忙，图片上传失败，请重试"},uploadSuccess:function(e){this.pathInput.val(e);this.img.attr("src",e);this.preview.show();this.showMessage("success","图片已上传成功");this.config.onUpload&&this.config.onUpload(e)},handleRemove:function(){var e=this;this.remove.click(function(){e.pathInput.val("");e.preview.hide();e.config.onRemove&&e.config.onRemove();return false})},showMessage:function(e,f){var g=this.message;g.removeClass("error success").stop(true);if(e===false){g.hide()}else{g.addClass(e).text(f).show()}}});a.diy.ImageUpload=b})(jQuery,Platform.winport);