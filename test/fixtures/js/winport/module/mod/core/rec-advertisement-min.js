(function(c,b){var f=b.Util,d=b.UI,a=b.widget.TraceLog;var e=f.mkclass({template:'<ul class="offer-list-sub">			<% jQuery.each(offers, function(index, offer) { %>			<li <% if (index === offers.length - 1) { %>class="last" <% } %>>				<div class="image"><a href="<%= offer.url %>" title="<%= offer.title %>" target="_blank"><img src="<%= offer.img %>" alt="<%= offer.title %>" width="64" height="64" /></a></div>				<div class="title"><a href="<%= offer.url %>" title="<%= offer.title %>" target="_blank"><%= offer.shortTitle %></a></div>				<% if (offer.price) { %><div class="price"><span class="cny">&yen;</span> <em><%= offer.price %></em></div><% } %>			</li>			<% }); %>		 </ul>',init:function(l,i){this.div=l;this.config=i;var h=i.requestUrl,j=i.requestType||"default",k=e.Action[j];k.request(h,c.proxy(this,"render"))},render:function(i){var h=this;this.filter(i);d.sweetTemplate(c("div.m-content",this.div),this.template,{offers:i},function(){h.afterRender(i)})},filter:function(i){var h=this,j="http://img.china.alibaba.com/images/app/winport/layout/sidebar/nopic_64.gif";c.each(i,function(k,l){l.title=c.util.escapeHTML(l.title);l.shortTitle=h.formatTitle(l.title)})},formatTitle:function(h){return f.lenB(h)>42?f.cut(h,40)+"..":h},afterRender:function(h){var i=c("div.image img",this.div);d.resizeImage(i,64);c("li",this.div).each(function(j){c(this).data("offer",h[j])});this.handleClickTrace();this.handleExposureTrace(h)},handleClickTrace:function(){var h=this,i=g.getPageParams();new a("li div.image,li div.title a",{delegate:this.div,url:"http://stat.china.alibaba.com/bt/1688_click.html",param:function(k){var j=c(k).closest("li").data("offer")||{};return{page:32,pid:i.pid,objectId:j.id,recId:i.recid,alg:j.alg||0,objectType:"offer",st_page_id:i.pageid,ver:30,time:c.now()}}})},handleExposureTrace:function(h){var j=g.getPageParams(),i=c.map(h,function(k){return k.id+","+(k.alg||0)}).join(";");new a(this.div,{when:"exposure",url:"http://ctr.china.alibaba.com/ctr.html",param:{ctr_type:32,page_area:j.recid,page_id:j.pageid,category_id:"",object_type:"offer",object_ids:i,keyword:"",page_size:"",page_no:"",time:c.now()}})}});e.Action={};e.Action["default"]={request:function(i,k){var h=this,j=this.getParams();c.ajax(i,{dataType:"jsonp",data:j,success:function(l){var l=l.data||{};if(l.returnCode!==0){c.log("error: "+l.returnMsg);return}k(h.filter(l.data))}})},getParams:function(){var h=g.getPageParams();return{uid:h.uid,recid:h.recid,pageid:h.pageid,memberid:h.memberId,querywords:this.getQueryWords()}},getQueryWords:function(){var h=this.getLastSearchDate(),i=null,j=null;if(!h){return}i=(new Date()).getTime()-h.getTime();if(i<30*60*1000){j=(c.util.cookie("h_keys",false,{raw:true})||"").split("#")[0];return j&&unescape(j)}},getLastSearchDate:function(){var i=c.util.cookie("ad_prefer"),k=/(\d+)\/(\d+)\/(\d+)\s+(\d+):(\d+):(\d+)/,h=null,j=null;if(!i||!(h=k.exec(i))){return}i=new Date();i.setFullYear(h[1],parseInt(h[2],10)-1,h[3]);i.setHours(h[4],h[5],h[6]);return i},filter:function(i){var h=this,j="http://img.china.alibaba.com/images/app/winport/layout/sidebar/nopic_64.gif";return c.map(i,function(k){return{id:k.offerId,url:k.eURL||k.offerDetailUrl,img:k.offerImageUrl?k.offerImageUrl+".summ.jpg":j,title:k.subject,price:k.rmbPrice?parseFloat(k.rmbPrice).toFixed(2):"",alg:k.alg}})}};e.Action.p4p={request:function(i,k){var h=this,j=this._getParams();c.ajax(i,{data:j,dataType:"script",success:function(){var l=window.p4pOffers;if(!l){return}l=h._filter(l);k(l)}})},_getParams:function(){var j=g.getPageParams(),i=j.detail||{},h=i.dcatid||3;if(i.parentdcatid){h=h+","+i.parentdcatid+","+h}return{count:5,offset:5,pid:j.pid,p4p:"p4pOffers",mt:"ec",dcatid:h,pageid:j.pageid,t:(new Date()).getTime()}},_filter:function(h){return c.map(h,function(i){return{id:i.RESOURCEID,url:i.EURL||i.CLICKURL,img:i.OFFERIMGURL,title:i.TITLE,price:c.trim(""+i.OFFERPRICE)}})}};var g={getPageParams:function(){var i=window.iDetailConfig,h=c("#doc").data("docConfig").uid;return{detail:i,uid:FE.util.loginId||-1,recid:i?1030:1110,pageid:window.dmtrack_pageid,pid:i?"819095_1008":"819094_1008",memberId:h}}};b.ModContext.register("wp-rec-advertisement",e)})(jQuery,Platform.winport);