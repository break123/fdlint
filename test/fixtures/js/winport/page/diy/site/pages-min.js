(function(e,c){var g=c.Util,b=c.UI,d=c.diy.Msg,i=c.diy.Diy,f=c.diy.ModBox;var h={init:function(k,j){this.div=k;this.config=j;this.parts=e("div.pages-part",k);this._initPartEffect();this.name="DiyPages";g.initParts(this)},refreshPageNav:function(){var j=e("#winport-header div.wp-top-nav"),k=j.closest("div.mod-box");f.reload(k)},wrapUpdateData:function(j){return e.extend({_csrf_token:e("#doc").data("doc-config")._csrf_token},j)},_initPartEffect:function(){e("tr",this.parts).live("mouseenter mouseleave",function(j){e(this).toggleClass("hover",j.type==="mouseenter")})}};var a=(h.Parts={});a.PageSorter={init:function(){var j=this;e(this.div).data("pagelist",this.getPageList());this.parts.each(function(){j.initPart(e(this))});this.refresh()},initPart:function(j){this.initUpDown(j);this.initSortable(j)},initUpDown:function(j){var k=e("a.sort-up,a.sort-down",j);this.initUpDownSort(k);this.initUpDownEffect(k)},initUpDownSort:function(k){var j=this;k.live("click",function(){var n=e(this),m=n.closest("tr.sortable"),l=n.hasClass("sort-up"),o=m[l?"prev":"next"](".sortable");if(o){o[l?"before":"after"](m);j.updateSort("updown")}return false})},initUpDownEffect:function(j){j.live("mouseenter",function(){var k=e(this);j.removeClass("sort-up-hover sort-down-hover");k.addClass(k.hasClass("sort-up")?"sort-up-hover":"sort-down-hover")});j.live("mouseleave",function(){e(this).removeClass("sort-up-hover sort-down-hover")})},initSortable:function(k){var j=this;e.use("ui-portlets",function(){e("tbody",k).portlets({items:"tr.sortable",axis:"y",opacity:0.8,stop:function(){j.updateSort("drag")},revert:200,helper:function(m,l){return e("<table>").append(l.clone())},appendTo:k,capture:function(m,l){if(e.util.ua.ie6){e("input.:checkbox",l.currentItem).each(function(){this.defaultChecked=this.checked})}},start:function(m,l){e(l.placeholder).html('<td colspan="5">&nbsp;</td>')}})})},updateSort:function(m){var j=this,k=this.config.updatePageListUrl,l=null;this.refresh();l=function(){var o=e(j.div).data("pagelist"),n=j.getPageList();if(o===n){return}i.authAjax(k,{type:"POST",data:j.wrapUpdateData({pageList:n}),dataType:"json",success:function(p){if(p.success){e(j.div).data("pagelist",n);j.refreshPageNav();e(window).trigger("diychanged",{type:"update-page-list-"+m});d.info("调整导航页顺序成功")}else{d.error("调整导航页顺序失败，请刷新后重试。")}}})};g.schedule("update-pagelist",l)},getPageList:function(){var j=e("tr[data-page]:not(.ui-portlets-placeholder)",this.div),k=[];j.each(function(){var l=e(this).data("page");k.push(l.sid)});return JSON.stringify(k)},refresh:function(){this.parts.each(function(){var k=e(this),j=e("a.sort-up",k),l=e("a.sort-down",k);j.removeClass("sort-up-disabled");l.removeClass("sort-down-disabled");j.eq(0).addClass("sort-up-disabled");l.eq(l.length-1).addClass("sort-down-disabled")})}};a.PageNameEditor={init:function(){var j=this;e.use("wp-inplaceeditor",function(){j.parts.each(function(){j.initEditable(e(this))})})},initEditable:function(k){var j=this,l=function(){var m=e(this).closest("tr.editable");e("a.save,a.cancel",m).hide();e("a.edit",m).show()};e("tr.editable td.col-name",k).inplaceEditor({event:"dblclick",autosubmit:false,attr:{maxlength:4},validate:function(n,m){if(/[~'"@#$?&<>\/\\]/.test(n)){d.warn("页面名称含有非法字符，请重新输入");return false}return true},submit:function(m,n){j.doSubmit(m,n,this)},onstart:function(){var m=e(this).closest("tr.editable");e("a.edit",m).hide();e("a.save,a.cancel",m).show();e("a.save",m).css("display","inline-block")},oncancel:function(){j.completeEdit(this)}});e("tr.editable",k).delegate("a.save,a.cancel,a.edit","click",function(){var o=e(this),m=o.closest("tr.editable").find("td.col-name"),n=o.hasClass("save")?"submit":o.hasClass("edit")?"start":"cancel";m.inplaceEditor(n);return false})},completeEdit:function(k){var j=e(k).closest("tr.editable");e("a.save,a.cancel",j).hide();e("a.edit",j).show()},doSubmit:function(m,o,n){var j=this,l=this.config.updatePageNameUrl,k=e(n).closest("tr.editable").data("page");i.authAjax(g.formatUrl(l,"_input_charset=UTF-8"),{type:"POST",data:this.wrapUpdateData({pageSid:k.sid,pageName:m}),dataType:"json",success:function(p){if(p.success){o({status:"success"});d.info("修改名称成功");j.refreshPageNav();j.completeEdit(n);e(window).trigger("diychanged",{type:"update-page-name"})}else{var q=p.data[0].message;o({status:"error"});q&&d.error(q)}},error:function(){o({status:"error"})}})}};a.PageNavStatusUpdater={init:function(){var j=this,k=this.config.updatePageNavStatusUrl;this.checks=e("input.pagenav-status",this.div);this.saveStatus();this.checks.live("click",function(l){if(!j.validateStatus(this.checked)){l.preventDefault();return}action=function(){var m=j.getStatusData();if(!m){return}i.authAjax(k,{type:"POST",data:j.wrapUpdateData(m),dataType:"json",success:e.proxy(j,"success")})};g.schedule("update-pagenav-status",action)})},saveStatus:function(){this.checks.each(function(){var j=e(this);j.data("last-checked",this.checked)})},validateStatus:function(j){var l=this.checks.filter(":checked").length,m=this.config.maxPageNum,k="最多可显示{0}个导航页，设置导航页失败";if(j&&m&&l>m){d.error(e.util.substitute(k,[m]));return false}return true},getStatusData:function(){var j=[];this.checks.each(function(){var k=e(this),m=null,l=null;if(k.data("last-checked")===this.checked){return}m=k.closest("tr");l=m.data("page");j.push("{"+l.sid+":"+(this.checked?"true":"false")+"}")});return j.length?{pageNavList:"["+j.join(",")+"]"}:null},success:function(j){if(j.success){this.saveStatus();e(window).trigger("diychanged",{type:"update-page-nav-status"});d.info("设置导航页成功")}else{d.error("设置导航页失败")}this.refreshPageNav()}};c.SettingContext.register("diy-pages",h,{configField:"pagesConfig"})})(jQuery,Platform.winport);