(function(e,b){var d=b.ModContext,g=b.widget.Dialog,a=b.widget.Tabs,f=b.diy.ModBox,c=b.diy.Msg,i=b.diy.Component;var h=new b.Class({init:function(l,k,j){l=e(l).eq(0);this.insertRegion=l;this.insertIndex=(k===false||k===undefined||k===-1)?e("div.mod-box",l).length:k;this.options=j||{};this.contentCfg=i.getContentConfig();this.open(l,k)},open:function(m,l){var j=this,k=this.contentCfg.listWidgetUrl;this.dialog=new g({className:"mod-list-dialog",header:"添加板块",hasFooter:false,draggable:true,contentUrl:k,contentParams:this.getRequestData(m),contentSuccess:function(n){j.panel=e("div.mod-list-panel",n.element);j.initTabs();j.initStatus();j.handleAddMod();j.options.success&&j.options.success(n)}})},getRequestData:function(k){var j=k.closest("div.layout-box").data("boxConfig");return{pageCid:this.contentCfg.cid,pageSid:this.contentCfg.sid,segment:k.closest("div.segment").data("segmentConfig").cid,layoutCid:j.cid,layoutSid:j.sid,region:k.data("regionConfig").cid,_csrf_token:i.getDocConfig()._csrf_token}},initTabs:function(){var k=e("ul.mod-tabs li",this.panel),j=e("div.mod-list-group",this.panel);j.hide();new a(k,j);j.each(function(){var n=e(this),l=e("ul.group-tabs li",n),m=e("div.group-body ul.mod-list",n);m.hide();new a(l,m)})},initStatus:function(){var j=this,m=this.getBoxConfigMap(),l=this.getRegionBoxConfigMap(),k=e("ul.mod-list li",this.panel);k.each(function(){var n=e(this),q=e(this).data("addConfig").cid,p=m[q],o=null;if(p&&(o=p.config)){if(l[q]&&o.singletonInRegion||o.maxCount>0&&o.maxCount<=p.count){n.addClass("status-added");return}}})},getBoxConfigMap:function(){var j={};boxes=e("#content div.mod-box");boxes.each(function(){var k=e(this).data("boxConfig"),m=k.cid,l=null;l=j[m]=j[m]||{config:k};l.count=(l.count||0)+1});return j},getRegionBoxConfigMap:function(){var l=this.insertRegion,j=e("div.mod-box",l),k={};j.each(function(){var m=e(this).data("boxConfig");k[m.cid]=true});return k},handleAddMod:function(){var j=this;this.panel.delegate("a.add-mod","click",function(m){m.preventDefault();var k=e(this).closest("li"),l=k.data("addConfig");if(j.panel.data("running")||k.hasClass("running")){return}j.panel.data("running",true);k.addClass("running");f.add({cid:l.cid,region:j.insertRegion,index:j.insertIndex,success:function(){c.info("添加板块成功");j.dialog.close()},error:function(n){j.panel.data("running",false);k.removeClass("running");c.error(n)}})})}});b.diy.ModListDialog=h})(jQuery,Platform.winport);