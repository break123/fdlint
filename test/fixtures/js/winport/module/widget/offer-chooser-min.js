(function(e,d){var i=d.Util,c=d.UI;var f={showLoading:function(l){l.html('<div class="loading">正在加载...</div>')},showMessage:function(o,l,n){var m=e('<div class="message">'+l+"</div>");o.empty().append(m);m.delay(5000).fadeOut(function(){m.remove();n&&n()})},filterOffer:function(l){var m=e.extend({},l);m.formatedTitle=l.title.length>20?l.title.substr(0,20)+"..":l.title;m.formatedTitle=e.util.escapeHTML(m.formatedTitle,true);m.title=e.util.escapeHTML(l.title,true);m.image=l.image||"http://img.china.alibaba.com/images/app/platform/winport/mod/offers/nopic-64.png";m.price=e.util.escapeHTML(""+l.price,true).replace(/(\d+(?:\.\d+)?)/,"<em>$1</em>");return m},handleOfferListHover:function(l){l.delegate("li","mouseenter",function(){e("li",l).removeClass("hover");e(this).addClass("hover")})}};var j=new d.Class({init:function(l){this.config=l;this.node=e(this._template);this.node.appendTo(l.appendTo);this.selectedOfferPart=new b(this);e.extend(this,i.delegate(this.selectedOfferPart,["getSelectedOffers","getSelectedOffersId"]));this.sourceOfferPart=new g(this)},_template:'<div class="widget-offer-chooser">	<div class="source-offer-part">		<div class="w-header">			<h3></h3>		</div>		<div class="search-panel">			<div class="search-cats ui-combobox">				<input type="text" readonly="readonly" autocomplete="off" class="result">				<a hidefocus="true" href="javascript:;" class="trigger"></a>			</div>			<input type="text" class="search-text" maxlength="50" />			<a href="#" class="search-btn">搜索</a>		</div>		<div class="offer-list"></div>		<div class="paging-nav"></div>	</div>	<div class="selected-offer-part">		<div class="w-header"><h3></h3></div>		<div class="offer-list"></div>		<div class="expire-message">过期信息无法在旺铺中展示，请重发或更换信息！</div>	</div></div>'});var g=new d.Class({init:function(l){this.Chooser=l;this.node=l.node;this.config=l.config;this.part=e("div.source-offer-part",this.node);this._offerList=e("div.offer-list",this.part);this._params={category:this.config.selectedCategory,pageIndex:1,pageSize:5};this._renderHeader();this._handleOfferList();this._handleOfferAddRemove();new h(this);new k(this);this.loadOffers()},_renderHeader:function(){var m=e("div.w-header",this.part),l=this.config.comeback;this._renderTitle(m);l&&this._renderComeback(m,l)},_renderTitle:function(l){e("h3",l).html(this.config.sourceOfferTitle||"我的供应信息")},_renderComeback:function(n,m){m=typeof m==="function"?{text:"返回",action:m}:m;var l=e(e.util.substitute('<a href="#" class="comeback">{text}</a>',m));l.click(function(o){o.preventDefault();m.action()});n.append(l)},_handleOfferList:function(){var l=this;this._offerList.delegate("a.select-btn","click",function(o){o.preventDefault();var m=e(this).closest("li"),n=m.data("offer");l.node.triggerHandler("offer.select",n)});f.handleOfferListHover(this._offerList)},_handleOfferAddRemove:function(){var l=this;this.node.bind("offer.remove",function(o,n){var m=l._getOfferItem(n);m.removeClass("status-added");e(l._offerList).removeClass("status-full")});this.node.bind("offer.add",function(o,n){var m=l._getOfferItem(n);m.addClass("status-added")});this.node.bind("offer.full",function(){e(l._offerList).addClass("status-full")})},_getOfferItem:function(l){return e("li",this._offerList).filter(function(){return e(this).data("offer").id===l.id})},loadOffers:function(m){var l=this;m&&e.extend(this._params,m);f.showLoading(this._offerList);this.config.dataProvider.searchOffers(this._params,function(n){l._renderOfferList(n.offers);l.node.trigger("offer.load",n)},function(){f.showMessage(l._offerList,"网络繁忙，请稍候重试")})},_renderOfferList:function(o){var l=this,n=this.Chooser.getSelectedOffersId(),m=e("<ul>");e.each(o,function(r,s){var q=e.util.substitute(l._template,f.filterOffer(s)),p=e(q);p.data("offer",s);if(n&&e.inArray(s.id,n)!==-1){p.addClass("status-added")}s.price||e("dd.price",p).remove();m.append(p)});this._offerList.empty().append(m);c.resizeImage(e("li .image img",this._offerList),50)},_template:'<li>	<dl>		<dt class="image"><a href="{detailUrl}" class="wrap" title="{title}" target="_blank"><img src="{image}" alt="{title}" /></a></dt>		<dd class="title"><a href="{detailUrl}" title="{title}" target="_blank">{formatedTitle}</a></dd>		<dd class="price">{price}</dd>		<dd class="date">{date}</dd>	</dl>	<div class="op">		<a href="#" class="select-btn">选择</a>		<span class="offer-added">已选择</span>	</div></li>'});var h=new d.Class({init:function(l){this.Part=l;this.node=l.node;this.part=l.part;this.config=l.config;this.searchPanel=e("div.search-panel",this.part);this._initSearchCats();this._handleSearchBtn()},_initSearchCats:function(){var l=this,n=e("div.search-cats",this.searchPanel),m=this.config.selectedCategory;if(m){l._renderSelectedCat(n,m);this._selectedCat=m;return}this.config.dataProvider.loadCategories(function(o){l._renderSearchCats(n,o)})},_renderSelectedCat:function(n,l){var m=e("input.result",n);m.val(this._formatResult(l.name));n.addClass("no-combobox")},_renderSearchCats:function(m,l){e.use("ui-combobox",e.proxy(this,"__renderSearchCats",m,l))},__renderSearchCats:function(q,o){var n=this,m=n._createItems(o),p=e("a.search-btn",this.searchPanel),l={id:"",name:"全部信息"};m.unshift({text:l.name,value:"0",cat:l});q.empty().combobox({value:"0",data:m,resultTpl:function(r){return n._formatResult(r.cat.name)},change:function(){var r=e("li.ui-combobox-selected",q);n._selectedCat=r.data("item").cat;p.click()}});this._renderSearchCatsSeparator(q,m)},_formatResult:function(l){return l.substr(0,6)},_renderSearchCatsSeparator:function(o,l){var m=e("li.ui-combobox-item",o),n=null;m.each(function(r){var q=e(this),p=l[r].cat,s=p.type;q.attr("title",e.util.escapeHTML(p.name,true));if(!s){return}if(n&&n!==s){q.addClass("item-separator")}n=s})},_createItems:function(n,o){var m=this,l=[];o=o||0;e.each(n,function(q,p){l.push({text:m._formatCatName(p.name,o),value:p.id,cat:p});if(p.children){l.push.apply(l,m._createItems(p.children,o+1))}});return l},_formatCatName:function(l,o){var n="";for(var m=0;m<o;m++){n+="&nbsp;&nbsp;&nbsp;"}l=l||"";l=l.length>10?l.substr(0,10)+"..":l;return n+e.util.escapeHTML(l,true)},_handleSearchBtn:function(){var m=this,l=this.searchPanel,n=e("a.search-btn",l),o=e("input.search-text",l);n.click(function(p){p.preventDefault();var q={pageIndex:1,category:m._selectedCat,keywords:e("input.search-text",l).val()};m.Part.loadOffers(q)});o.keydown(function(p){if(p.keyCode===13){p.preventDefault();n.click()}})}});var k=new d.Class({init:function(l){this.Part=l;this.node=l.node;this.part=l.part;this.config=l.config;this.pagingNav=e("div.paging-nav",this.part);this._handleOffersLoad();this._handlePagingNav();this._handleJumpto()},_handleOffersLoad:function(){var l=this;this.node.bind("offer.load",function(n,m){l.paging=e.extend({pageIndex:1,pageCount:0},m);l._render();l._handleJumptoTextValidate()})},_render:function(){var n=this.paging,m=this.pagingNav,l=n.pageIndex,q=null,o=[],p='<a href="page/{page}" class="{class}" data-page="{page}">{text}</a>';q=this._createData(n);o.push(e.util.substitute(p,{"class":"page-prev",page:l-1,text:"上一页"}));e.each(q,function(r,s){o.push(e.util.substitute(p,{"class":s[2],page:s[0],text:s[1]}))});o.push(e.util.substitute(p,{"class":"page-next",page:l+1,text:"下一页"}));o.push('跳转至 <input type="text" class="jumpto-text" /> 页 <a href="#" class="jumpto-btn">确定</a>');m.empty().html(o.join("")).show();l<=1&&e("a.page-prev",m).addClass("disabled");l>=n.pageCount&&e("a.page-next",m).addClass("disabled")},_createData:function(m){var t=[],o=m.pageIndex,n=m.pageCount>1?m.pageCount:1,s=7,q=o-Math.floor((s-4)/2),r,l;q+s-2>n&&(q=n-s+3);q<3&&(q=3);r=q;for(var p=0;p<s-4;p++){if(r>n-2){break}t.push([r,r,"page-num"]);r++}r--;if(n>1){l=Math.floor((q+1)/2);t.unshift(q>l+1?[l,"...","page-num omit"]:[l,l,"page-num"])}if(n>0){t.unshift([1,1,"page-num"])}if(n>2){l=Math.floor((n+r+1)/2);t.push(r<l-1?[l,"...","page-num omit"]:[l,l,"page-num"])}if(n>3){t.push([n,n,"page-num"])}e.each(t,function(u,v){if(v[0]===o){v[2]+=" current";return false}});return t},_handleJumptoTextValidate:function(){var m=this,l=e("input.jumpto-text",this.pagingNav);e.use("wp-instantvalidator",function(){d.widget.InstantValidator.validate(l,"pagenum")})},_handlePagingNav:function(){var l=this;this.pagingNav.delegate("a[data-page]","click",function(n){n.preventDefault();var m=e(this);if(m.hasClass("disabled")||m.hasClass("current")){return}l.Part.loadOffers({pageIndex:e(this).data("page")})})},_handleJumpto:function(){var l=this;this.pagingNav.delegate("a.jumpto-btn","click",function(p){p.preventDefault();var n=e("input.jumpto-text",l.pagingNav),o=parseInt(n.val()),m=l.paging.pageCount;if(!o||o==l.paging.pageIndex){return}o=o<1?1:o>m?m:o;l.Part.loadOffers({pageIndex:o})});this.pagingNav.delegate("input.jumpto-text","keydown",function(m){if(m.keyCode===13){e("a.jumpto-btn",l.pagingNav).click();return false}})}});var b=new d.Class({init:function(l){this.Chooser=l;this.node=l.node;this.config=l.config;this.part=e("div.selected-offer-part",this.node);this.title=e("h3",this.part);this.offerList=e("div.offer-list",this.part);this.expireMessage=e("div.expire-message",this.part);this.maxSelectedCount=this.config.maxSelectedCount||16;this._handleOfferSelect();this._handleOfferChange();this._initOfferList()},_initOfferList:function(){this._loadSelectedOffers();f.handleOfferListHover(this.offerList);this._handleOfferListRemove();this._handleOfferListUpDown();this._initOfferListSortable()},_loadSelectedOffers:function(){var l=this,m=this.config.selectedOffers||[];if(m.length===0){this._renderEmptyOfferList();return}f.showLoading(this.offerList);this.config.dataProvider.loadOffers(m,function(n){l._renderOfferList(n.offers);if(n.offers.length===l.maxSelectedCount){l.node.trigger("offer.full")}l.inited=true},function(){f.showMessage(l.offerList,"网络繁忙，请稍候重试",e.proxy(l,"_renderEmptyOfferList"))})},_renderEmptyOfferList:function(){this.offerList.append(e("<ul>"));this.inited=true;this._refreshStatus()},_renderOfferList:function(n){var l=this,m=e("<ul>");e.each(n,function(o,p){m.append(l._createOfferItem(p));l.node.trigger("offer.add",p)});this.offerList.empty().append(m);this._refreshStatus()},_createOfferItem:function(n){var m=e.util.substitute(this._template,f.filterOffer(n)),l=e(m);l.data("offer",n);c.resizeImage(e(".image img",l),50);n.price||e("dd.price",l).remove();n.expire||e("dd.status-expire",l).remove();return l},_handleOfferListRemove:function(){var l=this;this.offerList.delegate("a.delete-btn","click",function(o){o.preventDefault();var m=e(this).closest("li"),n=m.data("offer");m.remove();l.node.trigger("offer.remove",n)})},_handleOfferListUpDown:function(){var l=this;this.offerList.delegate("a.up-btn,a.down-btn","click",function(q){q.preventDefault();var n=e(this).closest("li"),p=n.data("offer"),m=e(this).hasClass("up-btn"),o=n[m?"prev":"next"]();l._swapOfferItem(n,o,function(){l.node.trigger("offer.move",p)})})},_swapOfferItem:function(r,q,s){var t=this,u=r.position(),o=q.position(),p=r.clone(),n=q.clone(),l=0,m=null;this.offerList.addClass("status-animate");p.css({position:"absolute",left:u.left,top:u.top,background:"#f6f6f6",opacity:0.8}).insertAfter(r);n.css({position:"absolute",left:o.left,top:o.top,background:"#f6f6f6",opacity:0.8}).insertAfter(q);m=function(){if(++l<2){return}p.remove();n.remove();r.index()<q.index()?q.after(r):r.after(q);r.css("visibility","visible");q.css("visibility","visible");t.offerList.removeClass("status-animate");s()};r.css("visibility","hidden");q.css("visibility","hidden");p.animate({top:o.top},m);n.animate({top:u.top},m)},_initOfferListSortable:function(){var l=this;e.use("ui-portlets",function(){e(l.offerList).portlets({items:"li",axis:"y",opacity:0.8,stop:function(o,n){var m=n.currentItem.data("offer");l.node.trigger("offer.move",m)},revert:200})})},getSelectedOffers:function(){var l=[];e("li",this.offerList).each(function(){l.push(e(this).data("offer"))});return l},getSelectedOffersId:function(){if(!this.inited){return}var l=this.getSelectedOffers();return e.map(l,function(m){return m.id})},_handleOfferSelect:function(){var l=this;this.node.bind("offer.select",function(q,p){var n=l.getSelectedOffersId(),m=e("ul",l.offerList),o=null;if(!l.inited||e.inArray(p.id,n)!==-1){return}if(n.length>=l.maxSelectedCount){return}o=l._createOfferItem(p);m.append(o);l.node.trigger("offer.add",p);if(n.length+1===l.maxSelectedCount){l.node.trigger("offer.full")}})},_handleOfferChange:function(){var l=this;this.node.bind("offer.add offer.remove offer.move",function(){l.inited&&l._refreshStatus()})},_refreshStatus:function(){this._renderTitle();this._renderOfferListEffect();this._renderExpireMessage()},_renderTitle:function(){var m=this.config.selectedOfferTitle||"已选择<em>{selectedCount}</em>条，您共可选择<em>{maxSelectedCount}</em>条",l=e("li",this.offerList).length;m=e.util.substitute(m,{selectedCount:l,maxSelectedCount:this.maxSelectedCount});this.title.html(m)},_renderOfferListEffect:function(){var l=e("li",this.offerList);l.removeClass("first last");l.first().addClass("first");l.last().addClass("last")},_renderExpireMessage:function(){var l=this,m=this.getSelectedOffers();this.expireMessage.hide();e.each(m,function(n,o){if(o.expire){l.expireMessage.show();return false}})},_template:'<li>	<dl>		<dt class="image"><div class="wrap"><img src="{image}" alt="{title}" /></div></dt>		<dd class="title">{formatedTitle}</dd>		<dd class="price">{price}</dd>		<dd class="status-expire">已过期</dd>	</dl>	<a href="#" class="delete-btn">删除</a>	<a href="#" class="up-btn">上移</a>	<a href="#" class="down-btn">下移</a></li>'});var a=new d.Class(d.widget.Dialog,{init:function(l){var m=e.extend({header:"选择产品",className:"offer-chooser-dialog",draggable:true},l,{contentSuccess:e.proxy(this,"_contentSuccess"),buttons:[{"class":"d-confirm",value:"确定"},{"class":"d-cancel",value:"取消"}]});this.parent.init.call(this,m)},_contentSuccess:function(m){var l=m.getContainer(),n=e.extend({appendTo:l},this.config);l.empty();this.offerChooser=new j(n);e.extend(this,i.delegate(this.offerChooser,["getSelectedOffers","getSelectedOffersId"]))}});d.widget.OfferChooser=j;d.widget.OfferChooserDialog=a;e.add("wp-offer-chooser")})(jQuery,Platform.winport);