(function(f,d){var c=d.ModContext,b=d.diy.Component,e=d.diy.FormDialog;var h={reload:function(l,p){if(l.length===0){f.error("assert false: box empty")}var j=this,o=l[0],m=l.closest("div.region"),n=l.data("boxConfig"),k=l.data("reloadAction"),i=function(){l.removeData("reloadAction")};k&&k.abort();l.trigger("beforereload");k=this.request({region:m.data("regionConfig").cid,cid:n.cid,sid:n.sid,success:function(q,r){j._reloadSuccess(l,r,function(){i();p&&p()})},error:i});l.data("reloadAction",k)},_reloadSuccess:function(k,j,m){var l=/<div[^>]*>([\s\S]+)<\/div>/,i=l.exec(j);if(!i){f.error("assert false: response html must contain in div.mod-box")}k.trigger("reloading");k.html(i[1]);c.refresh(f("div.mod",k));k.trigger("reloaded");m()},request:function(j){var k=b.getContentConfig(),i=k.getBoxUrl;return f.ajax(i,{cache:false,data:{pageSid:k.sid,pageCid:k.cid,region:j.region,cid:j.cid,sid:j.sid},success:function(l){var m=f(l).eq(0);if(m.is("div.mod-box")){j.success(m,l)}else{j.error&&j.error()}},error:j.error})},load:function(j){var k=j.region,i=j.index;this.request({region:k.data("regionConfig").cid,cid:j.cid,sid:j.sid,success:function(m,l){m=f(l);if(i===0){k.prepend(m)}else{f("div.mod-box",k).eq(i-1).after(m)}m=m.eq(0);c.refresh(f("div.mod",m));j.success&&j.success(m,l);m.trigger("loaded")},error:j.error})}};var a={edit:function(n,p){var o=n.data("boxConfig");if(!o.editable||f(window).triggerHandler("boxbeforeedit",{element:n[0]})===false){return false}var j=this,m=n.data("editConfig"),i=m.script[0],l=i?this._getHandler(i):"DefaultHandler",k=function(){j._openDialog(n,o,m,l);p&&p()};if(d.diy.form[l]){k();return}f.log("loading "+l);f.ajax(i,{dataType:"script",cache:false,success:k})},_openDialog:function(n,o,m,j){var l=d.diy.form[j],k=this._getDialogClassName(n)+" "+this._getDialogHandlerClassName(j),i={buttons:[{"class":"d-confirm",value:"确定"},{"class":"d-cancel",value:"取消"}],header:"设置板块："+m.widgetName,className:k.trim(),draggable:true,contentUrl:m.editFormUrl,ajaxParams:{type:"POST",data:{cid:o.cid}},handler:l,handlerName:j,formData:n};l.getFormConfig&&f.extendIf(i,l.getFormConfig(n));e.open(i)},_getDialogClassName:function(i){var j=this._getModId(i);return j?j+"-form-dialog ":""},_getDialogHandlerClassName:function(i){return i.replace(/[A-Z]/g,function(j){return"-"+j.toLowerCase()}).replace(/^-/,"")+"-dialog"},_getModId:function(k){var i=f("div.mod",k),j=(i[0].className||"").split(/\s+/),l=j[1]||"";return l.replace(/^\w+-/,"")},_getHandler:function(i){var j=i&&(/([^\/]+)\.js$/.exec(i)||{})[1];if(!j){return null}j=j.replace(/[-_](\w)/g,function(l,k){return k.toUpperCase()});return j.substr(0,1).toUpperCase()+j.substr(1)}};var g={add:function(i){this._validate(i)&&this._doAdd(i)},_validate:function(i){var m=b.getContentConfig(),l=m.maxCount,j=f("#content div.mod-box"),k=0;j.each(function(){var n=f(this).data("boxConfig");n&&n.deletable&&k++});if(l>0&&k>=l){i.error&&i.error(f.util.substitute("最多可添加{0}个板块，添加板块失败",[l]));return false}return true},_doAdd:function(k){var i=this,l=b.getContentConfig(),j=l.addWidgetUrl;f.ajax(j,{type:"POST",dataType:"json",data:this._getData(k),success:f.proxy(this,"_success",k),error:f.proxy(this,"_error",k)})},_getData:function(i){var j=b.getContentConfig(),k=i.region;return f.extendIf({cid:i.cid,version:j.version,index:i.index},b.getRegionPostData(i.region))},_success:function(i,k){var j=b.getContentConfig();if(k.success){++j.version;h.load({cid:i.cid,sid:k.data,region:i.region,index:i.index,success:function(l){f(window).trigger("diychanged",{type:"add-box",box:l});i.success(l)},error:function(){i.error&&i.error("载入板块失败，请刷新后重试")}})}else{if(k.data==="VERSION_EXPIRED"){window.location.reload()}else{this._error(i)}}},_error:function(i){i.error&&i.error("添加板块失败，请刷新后重试")}};d.diy.ModBox={reload:f.proxy(h,"reload"),request:f.proxy(h,"request"),load:f.proxy(h,"load"),edit:f.proxy(a,"edit"),add:f.proxy(g,"add")}})(jQuery,Platform.winport);